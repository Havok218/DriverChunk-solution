<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DriverChunk Solution - Login</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* [All CSS from previous version remains unchanged] */
    /* ... (use the exact CSS you provided before) ... */
  </style>
</head>
<body>

<!-- Google Sign-In container -->
<div id="g_id_onload"
     data-client_id="53569483362-gehsbf43esg5lijkt8lgcd6bd2b3g1mh.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
</div>
<div class="g_id_signin"
     data-type="standard"
     data-shape="pill"
     data-theme="outline"
     data-text="continue_with"
     data-size="large"
     data-logo_alignment="left">
</div>

<!-- Login / Signup form -->
<div id="login-container">
  <h2 id="form-title">Sign In</h2>

  <div id="error-msg" class="error"></div>

  <input type="text" id="username" placeholder="Username" autocomplete="username" />
  <input type="password" id="password" placeholder="Password" autocomplete="current-password" />

  <button id="action-btn">Sign In</button>

  <div class="toggle" id="toggle-form">Don't have an account? Sign Up</div>
</div>

<!-- Main page content hidden initially -->
<div id="main-page" role="main" aria-label="Main DriverChunk Content" tabindex="-1">
  <button id="logout-btn" aria-label="Logout">Logout</button>

  <header>DriverChunk Solution 2.0<br />Dark Mode & Light Mode Versions</header>
  <div id="credit">Developed by Arka Nandy</div>

  <main>
    <!-- [All your app content remains unchanged] -->
    <!-- ... -->
  </main>

  <section class="notice">
    WARNING: DriverChunk Solution 2.0 is a beta release. Use at your own risk and always backup your drivers before installing or updating.
  </section>

  <section class="about">
    DriverChunk Solution 2.0 is a free and open-source application built with the latest web technologies...
  </section>

  <section class="readme">
    Readme:{"\n"} • The app is currently for Windows OS only.{"\n"} • Requires administrator privileges to install or update drivers.{"\n"} • Regular updates coming soon with more features.
  </section>

  <footer>
    &copy; 2024 DriverChunk Solution by Arka Nandy. All rights reserved.
  </footer>
</div>

<script>
  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  const loginContainer = document.getElementById('login-container');
  const mainPage = document.getElementById('main-page');
  const errorMsg = document.getElementById('error-msg');
  const formTitle = document.getElementById('form-title');
  const toggleForm = document.getElementById('toggle-form');
  const actionBtn = document.getElementById('action-btn');
  const logoutBtn = document.getElementById('logout-btn');
  let isSignUp = false;

  toggleForm.addEventListener('click', () => {
    isSignUp = !isSignUp;
    formTitle.textContent = isSignUp ? 'Sign Up' : 'Sign In';
    actionBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
    toggleForm.textContent = isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up";
    errorMsg.textContent = '';
  });

  function validateUsername(u) {
    return /^[a-zA-Z0-9_]{3,}$/.test(u);
  }

  function loadUsers() {
    return JSON.parse(localStorage.getItem('users') || '{}');
  }

  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function getLoggedInUser() {
    return localStorage.getItem('loggedInUser');
  }

  function setLoggedInUser(username) {
    localStorage.setItem('loggedInUser', username);
  }

  function clearLoggedInUser() {
    localStorage.removeItem('loggedInUser');
  }

  function updateView() {
    const loggedIn = getLoggedInUser();
    if (loggedIn) {
      loginContainer.style.display = 'none';
      mainPage.style.display = 'flex';
      mainPage.querySelector('header').textContent = `Welcome, ${loggedIn} - DriverChunk Solution 2.0`;
      errorMsg.textContent = '';
    } else {
      loginContainer.style.display = 'flex';
      mainPage.style.display = 'none';
      formTitle.textContent = 'Sign In';
      actionBtn.textContent = 'Sign In';
      toggleForm.textContent = "Don't have an account? Sign Up";
      isSignUp = false;
    }
  }

  actionBtn.addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) {
      errorMsg.textContent = 'Please enter username and password.';
      return;
    }

    if (!validateUsername(username)) {
      errorMsg.textContent = 'Username must be at least 3 chars, letters/numbers/_ only.';
      return;
    }

    const users = loadUsers();
    const hashedPassword = await sha256(password);

    if (isSignUp) {
      if (users[username]) {
        errorMsg.textContent = 'User already exists. Please choose another username.';
        return;
      }
      users[username] = hashedPassword;
      saveUsers(users);
      errorMsg.style.color = 'lightgreen';
      errorMsg.textContent = 'User created! Please sign in.';
      toggleForm.click();
    } else {
      if (!users[username]) {
        errorMsg.textContent = 'User not found. Please sign up.';
        return;
      }
      if (users[username] !== hashedPassword) {
        errorMsg.textContent = 'Incorrect password.';
        return;
      }
      setLoggedInUser(username);
      updateView();
    }
  });

  logoutBtn.addEventListener('click', () => {
    clearLoggedInUser();
    updateView();
  });

  // Google OAuth callback
  function handleCredentialResponse(response) {
    const decoded = JSON.parse(atob(response.credential.split('.')[1]));
    const email = decoded.email || 'GoogleUser';
    setLoggedInUser(email);
    updateView();
  }

  window.onload = () => {
    updateView();
  };
</script>
</body>
</html>
